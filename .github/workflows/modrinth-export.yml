name: Build Modrinth Pack

on:
  push:
    paths:
      - "pack.toml"
      - "index.toml"
      - ".packwizignore"
      - "mods/**"
      - ".github/workflows/**"
  pull_request:
    paths:
      - "pack.toml"
      - "index.toml"
      - ".packwizignore"
      - "mods/**"
      - ".github/workflows/**"
  workflow_dispatch:

jobs:
  build:
    name: Build and export pack
    runs-on: ubuntu-latest
    container: 
      image: ghcr.io/lucanori/coder-templates:latest
      options: --user 0
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Verify packwiz installation
        run: packwiz --version
      
      - name: Capture pack metadata
        id: pack_meta
        run: |
          python3 << 'EOF'
          import tomllib
          import re
          import os
          
          with open('pack.toml', 'rb') as f:
              data = tomllib.load(f)
          
          name = data['name']
          version = data['version']
          slug = re.sub(r'[^a-zA-Z0-9]', '-', name.lower())
          export_path = f"build/{slug}-{version}.mrpack"
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"name={name}\n")
              f.write(f"version={version}\n")
              f.write(f"slug={slug}\n")
              f.write(f"export_path={export_path}\n")
          EOF
      
      - name: Export Modrinth pack
        run: |
          mkdir -p "$(dirname "${{ steps.pack_meta.outputs.export_path }}")"
          packwiz modrinth export --output "${{ steps.pack_meta.outputs.export_path }}"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: modrinth-pack
          path: ${{ steps.pack_meta.outputs.export_path }}